<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Autopost Control Panel</title>
    <style>
      :root {
        --bg: #0c1219;
        --panel: #111a24;
        --panel-2: #152234;
        --text: #e9f0f6;
        --muted: #9fb3c8;
        --accent: #39d98a;
        --danger: #ff5d5d;
        --warning: #f6c35e;
        --border: #1f2e42;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        background: radial-gradient(1200px 600px at 10% 10%, #16263a 0%, #0c1219 60%, #0c1219 100%);
        color: var(--text);
        font-family: "IBM Plex Sans", "Segoe UI", Tahoma, sans-serif;
      }
      header {
        padding: 24px 32px;
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
      }
      h1 {
        font-size: 20px;
        letter-spacing: 0.4px;
        margin: 0;
      }
      .container {
        padding: 24px 32px 64px;
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      }
      .card h2 {
        margin: 0 0 12px;
        font-size: 16px;
      }
      label { display: block; font-size: 12px; color: var(--muted); margin: 8px 0 4px; }
      input, textarea, select {
        width: 100%;
        padding: 10px 12px;
        background: var(--panel-2);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
      }
      button {
        margin-top: 10px;
        padding: 10px 14px;
        border: none;
        border-radius: 8px;
        background: var(--accent);
        color: #0c1219;
        font-weight: 600;
        cursor: pointer;
      }
      button.secondary { background: #24364c; color: var(--text); }
      button.danger { background: var(--danger); color: #fff; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
      .list {
        max-height: 260px;
        overflow: auto;
        font-size: 13px;
        color: var(--muted);
        border: 1px dashed var(--border);
        padding: 10px;
        border-radius: 8px;
        background: #0d1622;
      }
      .status {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }
      .pill {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        background: #24364c;
        color: var(--text);
        font-size: 11px;
        margin-right: 6px;
      }
      .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; }
      .badge.ok { background: #1f7a4f; color: #dff7ea; }
      .badge.warn { background: #7a5a1f; color: #fff0d5; }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 10px;
      }
      .mini {
        background: #0d1622;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px;
      }
      .chart {
        height: 60px;
        width: 100%;
        display: block;
        background: linear-gradient(180deg, #1c2d44 0%, #0d1622 100%);
        border-radius: 8px;
        margin-top: 6px;
      }
      .list code { color: #c4d8ef; }
      .split { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .log {
        max-height: 220px;
        overflow: auto;
        font-family: Consolas, "SFMono-Regular", monospace;
        font-size: 11px;
        background: #0b141f;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px;
        color: #b9cbe0;
      }
      .terminal-output {
        min-height: 220px;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Autopost Control Panel</h1>
      <div>
        <span class="pill" id="authState">Not Authenticated</span>
        <button class="secondary" onclick="loadAll()">Refresh</button>
      </div>
    </header>

    <div class="container">
      <div class="card">
        <h2>Authentication</h2>
        <label>Email</label>
        <input id="email" placeholder="you@example.com" />
        <label>Password</label>
        <input id="password" type="password" />
        <div class="row">
          <button onclick="register()">Register</button>
          <button class="secondary" onclick="login()">Login</button>
        </div>
        <button class="secondary" onclick="googleLogin()">Login with Google</button>
        <label>Token (auto-saved)</label>
        <textarea id="token" rows="3"></textarea>
        <button class="secondary" onclick="saveToken()">Save Token</button>
        <div class="status" id="authStatus"></div>
      </div>

      <div class="card">
        <h2>Create Site</h2>
        <label>Name</label>
        <input id="siteName" placeholder="My Site" />
        <label>WP URL</label>
        <input id="siteUrl" placeholder="https://example.com" />
        <div class="row">
          <div>
            <label>WP User</label>
            <input id="siteUser" />
          </div>
          <div>
            <label>WP App Password</label>
            <input id="sitePass" />
          </div>
        </div>
        <label>Niche</label>
        <input id="siteNiche" placeholder="Automation, SEO, Tech" />
        <label>Frequency Hours</label>
        <input id="siteFreq" value="24" />
        <button onclick="createSite()">Create Site</button>
        <div class="status" id="siteStatus"></div>
      </div>

      <div class="card">
        <h2>First User Setup</h2>
        <label>Admin Email</label>
        <input id="setupEmail" placeholder="you@example.com" />
        <label>Admin Password</label>
        <input id="setupPassword" type="password" />
        <label>Site Name</label>
        <input id="setupSiteName" placeholder="Primary Site" />
        <label>WP URL</label>
        <input id="setupWpUrl" placeholder="https://example.com" />
        <div class="row">
          <div>
            <label>WP User</label>
            <input id="setupWpUser" />
          </div>
          <div>
            <label>WP App Password</label>
            <input id="setupWpPass" />
          </div>
        </div>
        <label>Niche</label>
        <input id="setupNiche" placeholder="Automation, SEO, Tech" />
        <label>Frequency Hours</label>
        <input id="setupFreq" value="24" />
        <button onclick="firstSetup()">Create Admin + Site</button>
        <div class="status" id="setupStatus"></div>
      </div>

      <div class="card">
        <h2>Sites</h2>
        <button class="secondary" onclick="loadSites()">Load Sites</button>
        <div class="list" id="sitesList">No data</div>
        <label>Pick Site For Actions</label>
        <select id="siteSelect"></select>
        <div class="status" id="sitePickStatus"></div>
      </div>

      <div class="card">
        <h2>Automation</h2>
        <label>Site ID</label>
        <input id="runSiteId" placeholder="1" />
        <div class="row">
          <button onclick="runNow()">Run Now</button>
          <button class="secondary" onclick="startSite()">Start</button>
          <button class="secondary" onclick="stopSite()">Stop</button>
        </div>
        <div class="status" id="runStatus"></div>
        <label>Manual Slot Time (HH:MM)</label>
        <input id="slotTime" placeholder="10:00" />
        <div class="row">
          <button class="secondary" onclick="runSlot()">Run Slot</button>
          <button class="secondary" onclick="runUpdateOnly()">Update Only</button>
        </div>
      </div>

      <div class="card">
        <h2>Jobs</h2>
        <button class="secondary" onclick="loadJobs()">Load Jobs</button>
        <div class="list" id="jobsList">No data</div>
      </div>

      <div class="card">
        <h2>Published Posts</h2>
        <button class="secondary" onclick="loadPosts()">Load Posts</button>
        <div class="list" id="postsList">No data</div>
      </div>

      <div class="card">
        <h2>Health</h2>
        <div class="row">
          <button class="secondary" onclick="loadHealth()">Healthz</button>
          <button class="secondary" onclick="loadAdminHealth()">Admin Health</button>
        </div>
        <div class="list" id="healthStatus">No data</div>
      </div>

      <div class="card">
        <h2>Billing & Usage</h2>
        <button class="secondary" onclick="loadUsage()">Load Usage</button>
        <div class="list" id="usageStatus">No data</div>
        <label>Change Plan (free/pro/agency)</label>
        <input id="planName" placeholder="pro" />
        <button class="secondary" onclick="changePlan()">Change Plan</button>
        <div class="status" id="planStatus"></div>
      </div>

      <div class="card">
        <h2>Admin Controls</h2>
        <button class="secondary" onclick="loadUsers()">Load Users</button>
        <div class="list" id="usersList">No data</div>
        <label>User ID</label>
        <input id="adminUserId" placeholder="1" />
        <div class="row">
          <button class="danger" onclick="suspendUser()">Suspend</button>
          <button class="secondary" onclick="setLimit()">Set Limit</button>
        </div>
        <label>Limit</label>
        <input id="adminLimit" placeholder="100" />
        <div class="status" id="adminStatus"></div>
      </div>

      <div class="card">
        <h2>Schedule & Topics</h2>
        <div class="grid">
          <div class="mini">
            <label>Timezone</label>
            <input id="scheduleTz" placeholder="Asia/Karachi" />
          </div>
          <div class="mini">
            <label>Slots (HH:MM, comma)</label>
            <input id="scheduleSlots" placeholder="10:00,12:00,14:00,16:00,18:00" />
          </div>
        </div>
        <label>Topics (one per line)</label>
        <textarea id="scheduleTopics" rows="10"></textarea>
        <div class="row">
          <button onclick="loadSchedule()">Load</button>
          <button onclick="saveSchedule()">Save</button>
        </div>
        <div class="status" id="scheduleStatus"></div>
      </div>

      <div class="card">
        <h2>SEO Intelligence</h2>
        <button class="secondary" onclick="loadSEO()">Load trends/keywords/history</button>
        <div class="grid" id="seoGrid">
          <div class="mini"><div class="badge ok">Trends</div><div class="list" id="trendsList">No data</div></div>
          <div class="mini"><div class="badge ok">Top Keywords</div><div class="list" id="keywordsList">No data</div></div>
          <div class="mini"><div class="badge warn">History</div><div class="list" id="historyList">No data</div></div>
        </div>
      </div>

      <div class="card">
        <h2>Content Uniqueness Controls</h2>
        <div class="grid">
          <div class="mini">
            <label>Temperature</label>
            <input id="cfgTemperature" type="number" step="0.01" min="0" max="1.5" />
          </div>
          <div class="mini">
            <label>Similarity Max</label>
            <input id="cfgSimilarityMax" type="number" step="0.01" min="0" max="1" />
          </div>
          <div class="mini">
            <label>Rewrite Attempts</label>
            <input id="cfgRewriteAttempts" type="number" step="1" min="0" max="10" />
          </div>
        </div>
        <label>Source URLs (one per line)</label>
        <textarea id="cfgSourceUrls" rows="6"></textarea>
        <div class="row">
          <button class="secondary" onclick="loadContentSettings()">Load Settings</button>
          <button onclick="saveContentSettings()">Save Settings</button>
        </div>
        <div class="status" id="contentSettingsStatus"></div>
      </div>

      <div class="card">
        <h2>Performance Snapshot</h2>
        <button class="secondary" onclick="loadMetrics()">Load Metrics</button>
        <div class="grid">
          <div class="mini">
            <div>Posts (last 20)</div>
            <canvas id="impressionsChart" class="chart"></canvas>
          </div>
          <div class="mini">
            <div>Clicks (last 20)</div>
            <canvas id="clicksChart" class="chart"></canvas>
          </div>
        </div>
        <div class="list" id="metricsList">No data</div>
      </div>

      <div class="card">
        <h2>Performance Dashboard</h2>
        <div class="row">
          <button class="secondary" onclick="loadSchedulerStatus()">Scheduler Status</button>
          <button class="secondary" onclick="loadSchedulerProfile()">Scheduler Profile</button>
          <button class="secondary" onclick="loadRunReports()">Run Reports</button>
          <button onclick="startSchedulerDaemon()">Start Auto Scheduler</button>
          <button class="secondary" onclick="stopSchedulerDaemon()">Stop Auto Scheduler</button>
          <button class="secondary" onclick="loadSchedulerDaemonStatus()">Daemon Status</button>
          <button class="secondary" onclick="loadKaliEnvStatus()">Kali Env Status</button>
        </div>
        <div class="grid">
          <div class="mini">
            <div class="badge ok">Last Slot</div>
            <div id="lastSlot" class="status">No data</div>
            <div class="list" id="lastActions">No data</div>
          </div>
          <div class="mini">
            <div class="badge warn">Scheduler Log (tail)</div>
            <div id="logTail" class="log">No data</div>
          </div>
        </div>
        <div class="status" id="schedulerDaemonStatus">Daemon: unknown</div>
        <div class="status" id="kaliEnvStatus">Kali: unknown</div>
        <label>Recent Run Reports</label>
        <div class="list" id="runReports">No data</div>
      </div>

      <div class="card">
        <h2>Uniqueness Dashboard</h2>
        <button class="secondary" onclick="loadUniqueness()">Load Uniqueness Metrics</button>
        <div class="row">
          <div class="mini">
            <div class="badge ok">Avg Uniqueness</div>
            <div id="avgUniqueness" class="status">No data</div>
          </div>
          <div class="mini">
            <div class="badge warn">Avg Similarity</div>
            <div id="avgSimilarity" class="status">No data</div>
          </div>
        </div>
        <div class="list" id="uniquenessList">No data</div>
      </div>

      <div class="card">
        <h2>Fact-Check Dashboard</h2>
        <button class="secondary" onclick="loadFactCheck()">Load Fact-Check Metrics</button>
        <div class="grid">
          <div class="mini">
            <div class="badge ok">Triangulated</div>
            <div id="factTriangulated" class="status">No data</div>
          </div>
          <div class="mini">
            <div class="badge ok">Clear</div>
            <div id="factClear" class="status">No data</div>
          </div>
          <div class="mini">
            <div class="badge warn">Controversial</div>
            <div id="factControversial" class="status">No data</div>
          </div>
        </div>
        <div class="list" id="factCheckList">No data</div>
      </div>

      <div class="card">
        <h2>Site Audit</h2>
        <div class="row">
          <button onclick="runSiteAudit()">Run Full Audit</button>
          <button class="secondary" onclick="runRemediation()">Run Auto Fix</button>
        </div>
        <div class="row">
          <button class="secondary" onclick="loadSiteAudit()">Load Latest Audit</button>
        </div>
        <div class="status" id="siteAuditStatus"></div>
        <div class="list" id="siteAuditSummary">No data</div>
        <div class="row">
          <button class="secondary" onclick="runSEONormalize()">Run SEO Normalize</button>
          <button class="secondary" onclick="runQuickCycle()">Run Quick Cycle</button>
        </div>
        <div class="list" id="siteAuditIssues">No data</div>
      </div>

      <div class="card">
        <h2>Auto Publishing Control</h2>
        <div class="row">
          <button class="secondary" onclick="loadPostingStats()">Posting Stats</button>
          <button onclick="publishTenNow()">Publish 10 Now</button>
        </div>
        <label>Half-day Plan Posts</label>
        <input id="planHalfDayPosts" type="number" min="1" max="30" value="20" />
        <div class="row">
          <button class="secondary" onclick="applyHighPlan()">Apply High-Frequency Plan</button>
          <button class="secondary" onclick="runQuickCycle()">Run First Cycle</button>
        </div>
        <div class="status" id="postingControlStatus"></div>
        <div class="list" id="postingStatsList">No data</div>
      </div>



      <div class="card">
        <h2>Kali Linux Terminal</h2>
        <label>Kali Command</label>
        <input id="kaliCommand" placeholder="whoami && uname -a">
        <div class="row">
          <button onclick="runKaliCommand()">Run in Kali</button>
          <button class="secondary" onclick="clearKaliOutput()">Clear</button>
          <button class="secondary" onclick="loadKaliEnvStatus()">Refresh Kali Status</button>
        </div>
        <div class="status" id="kaliTerminalStatus">Ready</div>
        <div class="log terminal-output" id="kaliTerminalOutput">No output yet</div>
      </div>

      <div class="card">
        <h2>Cloud Terminal</h2>
        <label>Working Directory (repo relative)</label>
        <input id="terminalCwd" value="." placeholder=".">
        <label>Command</label>
        <input id="terminalCommand" placeholder="python --version">
        <div class="row">
          <button onclick="runTerminalCommand()">Run Command</button>
          <button class="secondary" onclick="clearTerminalOutput()">Clear</button>
        </div>
        <div class="status" id="terminalStatus">Ready</div>
        <div class="log terminal-output" id="terminalOutput">No output yet</div>
      </div>
    </div>

    <script>
      const tokenKey = "autopost_token";
      const refreshTokenKey = "autopost_refresh_token";
      const setStatus = (id, msg) => (document.getElementById(id).textContent = msg);
      const getToken = () => localStorage.getItem(tokenKey) || "";
      const setRefreshToken = (t) => localStorage.setItem(refreshTokenKey, t || "");
      const setToken = (t) => { localStorage.setItem(tokenKey, t); document.getElementById("token").value = t; updateAuthState(); };
      const updateAuthState = () => {
        document.getElementById("authState").textContent = getToken() ? "Authenticated" : "Not Authenticated";
      };

      const apiFetch = async (path, options = {}) => {
        const headers = options.headers || {};
        const token = getToken();
        if (token) headers["Authorization"] = `Bearer ${token}`;
        if (!headers["Content-Type"]) headers["Content-Type"] = "application/json";
        const res = await fetch(path, { ...options, headers });
        const text = await res.text();
        try { return { ok: res.ok, status: res.status, data: JSON.parse(text) }; }
        catch { return { ok: res.ok, status: res.status, data: text }; }
      };

      const register = async () => {
        const payload = { email: email.value, password: password.value };
        const res = await apiFetch("/auth/register", { method: "POST", body: JSON.stringify(payload) });
        if (res.ok && res.data.access_token) setToken(res.data.access_token);
        if (res.ok && res.data.refresh_token) setRefreshToken(res.data.refresh_token);
        setStatus("authStatus", JSON.stringify(res.data));
      };

      const login = async () => {
        const payload = { email: email.value, password: password.value };
        const res = await apiFetch("/auth/login", { method: "POST", body: JSON.stringify(payload) });
        if (res.ok && res.data.access_token) setToken(res.data.access_token);
        if (res.ok && res.data.refresh_token) setRefreshToken(res.data.refresh_token);
        setStatus("authStatus", JSON.stringify(res.data));
      };
      const googleLogin = () => {
        window.location.href = "/auth/google/login";
      };

      const saveToken = () => setToken(document.getElementById("token").value.trim());

      const createSite = async () => {
        const payload = {
          name: siteName.value,
          wp_url: siteUrl.value,
          wp_user: siteUser.value,
          wp_app_password: sitePass.value,
          openai_api_key: "",
          niche: siteNiche.value,
          frequency_hours: parseInt(siteFreq.value || "24", 10)
        };
        const res = await apiFetch("/sites", { method: "POST", body: JSON.stringify(payload) });
        setStatus("siteStatus", JSON.stringify(res.data));
      };
      const firstSetup = async () => {
        const payload = {
          email: setupEmail.value,
          password: setupPassword.value,
          site: {
            name: setupSiteName.value,
            wp_url: setupWpUrl.value,
            wp_user: setupWpUser.value,
            wp_app_password: setupWpPass.value,
            niche: setupNiche.value,
            frequency_hours: parseInt(setupFreq.value || "24", 10)
          }
        };
        const res = await apiFetch("/ui/first-setup", { method: "POST", body: JSON.stringify(payload) });
        if (res.ok && res.data.access_token) {
          setToken(res.data.access_token);
        }
        if (res.ok && res.data.refresh_token) {
          setRefreshToken(res.data.refresh_token);
        }
        setStatus("setupStatus", JSON.stringify(res.data));
      };

      const loadSites = async () => {
        const res = await apiFetch("/sites");
        sitesList.textContent = JSON.stringify(res.data, null, 2);
        const select = document.getElementById("siteSelect");
        if (!select) return;
        select.innerHTML = "";
        (res.data || []).forEach(site => {
          const opt = document.createElement("option");
          opt.value = site.id;
          opt.textContent = `${site.id} - ${site.name}`;
          select.appendChild(opt);
        });
        if ((res.data || []).length) {
          runSiteId.value = res.data[0].id;
          setStatus("sitePickStatus", "Site selected");
        } else {
          setStatus("sitePickStatus", "No sites available");
        }
      };

      const runNow = async () => {
        const id = runSiteId.value.trim();
        const res = await apiFetch(`/automation/${id}/run-now`, { method: "POST" });
        setStatus("runStatus", JSON.stringify(res.data));
      };
      const startSite = async () => {
        const id = runSiteId.value.trim();
        const res = await apiFetch(`/sites/${id}/start`, { method: "POST" });
        setStatus("runStatus", JSON.stringify(res.data));
      };
      const stopSite = async () => {
        const id = runSiteId.value.trim();
        const res = await apiFetch(`/sites/${id}/stop`, { method: "POST" });
        setStatus("runStatus", JSON.stringify(res.data));
      };
      const runSlot = async () => {
        const slot = slotTime.value.trim();
        const res = await apiFetch(`/ui/run-slot`, { method: "POST", body: JSON.stringify({ slot_time: slot }) });
        setStatus("runStatus", JSON.stringify(res.data));
      };
      const runUpdateOnly = async () => {
        const res = await apiFetch(`/ui/update-only`, { method: "POST" });
        setStatus("runStatus", JSON.stringify(res.data));
      };
      const loadHealth = async () => {
        const res = await apiFetch("/healthz");
        healthStatus.textContent = JSON.stringify(res.data, null, 2);
      };
      const loadAdminHealth = async () => {
        const res = await apiFetch("/admin/health");
        healthStatus.textContent = JSON.stringify(res.data, null, 2);
      };
      const loadUsage = async () => {
        const res = await apiFetch("/billing/usage");
        usageStatus.textContent = JSON.stringify(res.data, null, 2);
      };
      const changePlan = async () => {
        const plan = planName.value.trim();
        const res = await apiFetch(`/billing/change-plan/${plan}`, { method: "POST" });
        setStatus("planStatus", JSON.stringify(res.data));
      };
      const loadUsers = async () => {
        const res = await apiFetch("/admin/users");
        usersList.textContent = JSON.stringify(res.data, null, 2);
      };
      const suspendUser = async () => {
        const id = adminUserId.value.trim();
        const res = await apiFetch(`/admin/users/${id}/suspend`, { method: "POST" });
        setStatus("adminStatus", JSON.stringify(res.data));
      };
      const setLimit = async () => {
        const id = adminUserId.value.trim();
        const limit = adminLimit.value.trim();
        const res = await apiFetch(`/admin/users/${id}/limits/${limit}`, { method: "POST" });
        setStatus("adminStatus", JSON.stringify(res.data));
      };
      const loadJobs = async () => {
        const res = await apiFetch("/automation/jobs");
        jobsList.textContent = JSON.stringify(res.data, null, 2);
      };
      const loadPosts = async () => {
        const res = await apiFetch("/automation/posts");
        postsList.textContent = JSON.stringify(res.data, null, 2);
      };
      const loadSchedule = async () => {
        const res = await apiFetch("/ui/schedule");
        if (!res.ok) { setStatus("scheduleStatus", "Failed"); return; }
        scheduleTz.value = res.data.timezone || "Asia/Karachi";
        scheduleSlots.value = (res.data.slots || []).map(s => s.time).join(",");
        scheduleTopics.value = (res.data.topics || []).join("\\n");
        setStatus("scheduleStatus", "Loaded");
      };
      const saveSchedule = async () => {
        const slots = scheduleSlots.value.split(",").map(s => s.trim()).filter(Boolean).map(t => ({ time: t }));
        if (!slots.length) { setStatus("scheduleStatus", "Slots required"); return; }
        const topics = scheduleTopics.value.split("\\n").map(t => t.trim()).filter(Boolean);
        if (!topics.length) { setStatus("scheduleStatus", "Topics required"); return; }
        const payload = { timezone: scheduleTz.value || "Asia/Karachi", slots, topics };
        const res = await apiFetch("/ui/schedule", { method: "POST", body: JSON.stringify(payload) });
        setStatus("scheduleStatus", res.ok ? "Saved" : "Failed");
      };
      const loadSEO = async () => {
        const res = await apiFetch("/ui/seo");
        if (!res.ok) return;
        const trends = res.data["trends.json"]?.trends || [];
        const keywords = res.data["keywords.json"]?.keywords || [];
        const history = res.data["history.json"]?.articles || [];
        trendsList.textContent = trends.slice(0, 10).join("\\n");
        keywordsList.textContent = keywords.slice(0, 10).map(k => `${k.keyword} (${k.ranking_probability})`).join("\\n");
        historyList.textContent = history.slice(-10).map(h => `${h.title} | ${h.status}`).join("\\n");
      };
      const loadContentSettings = async () => {
        const res = await apiFetch("/ui/content-settings");
        if (!res.ok) return;
        cfgTemperature.value = res.data.content_temperature ?? 0.75;
        cfgSimilarityMax.value = res.data.content_similarity_max ?? 0.9;
        cfgRewriteAttempts.value = res.data.content_rewrite_attempts ?? 2;
        cfgSourceUrls.value = (res.data.content_source_urls || []).join("\\n");
        setStatus("contentSettingsStatus", "Loaded");
      };
      const saveContentSettings = async () => {
        const payload = {
          content_temperature: parseFloat(cfgTemperature.value || "0.75"),
          content_similarity_max: parseFloat(cfgSimilarityMax.value || "0.9"),
          content_rewrite_attempts: parseInt(cfgRewriteAttempts.value || "2", 10),
          content_source_urls: cfgSourceUrls.value.split("\\n").map(x => x.trim()).filter(Boolean)
        };
        const res = await apiFetch("/ui/content-settings", { method: "POST", body: JSON.stringify(payload) });
        setStatus("contentSettingsStatus", res.ok ? "Saved" : "Failed");
      };
      const loadMetrics = async () => {
        const res = await apiFetch("/ui/metrics");
        if (!res.ok) return;
        const perf = res.data.performance || [];
        metricsList.textContent = JSON.stringify(res.data.articles || [], null, 2);
        renderChart("impressionsChart", perf.map(p => p.impressions || 0));
        renderChart("clicksChart", perf.map(p => p.clicks || 0));
      };
      const formatDaemonState = (state) => {
        if (!state) return "Daemon: unknown";
        return state.running ? `Daemon: running (pid ${state.pid})` : "Daemon: stopped";
      };
      const loadSchedulerStatus = async () => {
        const res = await apiFetch("/ui/scheduler-status");
        if (!res.ok) return;
        lastSlot.textContent = res.data.last_slot || "No data";
        lastActions.textContent = JSON.stringify(res.data.last_actions || [], null, 2);
        logTail.textContent = (res.data.log_tail || []).join("\\n");
        schedulerDaemonStatus.textContent = formatDaemonState(res.data.daemon);
      };
      const loadSchedulerDaemonStatus = async () => {
        const res = await apiFetch("/ui/scheduler-daemon");
        if (!res.ok) {
          schedulerDaemonStatus.textContent = "Daemon status unavailable";
          return;
        }
        schedulerDaemonStatus.textContent = formatDaemonState(res.data);
      };
      const startSchedulerDaemon = async () => {
        const res = await apiFetch("/ui/scheduler-daemon/start", { method: "POST" });
        schedulerDaemonStatus.textContent = res.ok ? formatDaemonState(res.data) : "Failed to start daemon";
      };
      const stopSchedulerDaemon = async () => {
        const res = await apiFetch("/ui/scheduler-daemon/stop", { method: "POST" });
        schedulerDaemonStatus.textContent = res.ok ? formatDaemonState(res.data) : "Failed to stop daemon";
      };
      const loadKaliEnvStatus = async () => {
        const res = await apiFetch("/ui/kali-env/status");
        if (!res.ok) {
          kaliEnvStatus.textContent = "Kali: status unavailable";
          return;
        }
        const d = res.data || {};
        const state = d.container_running ? "running" : "stopped";
        kaliEnvStatus.textContent = `Kali: ${state} | docker=${d.docker_installed ? "yes" : "no"} | compose=${d.configured ? "yes" : "no"}`;
      };
      const loadSchedulerProfile = async () => {
        const res = await apiFetch("/ui/scheduler-profile");
        if (!res.ok) return;
        const s = res.data.summary || {};
        const fail = (res.data.recent_failures || []).join("\\n");
        logTail.textContent = `success_rate=${s.success_rate || 0}% | post_ok=${s.post_ok || 0} | post_fail=${s.post_fail || 0}\\n\\n${fail || "No recent failures"}`;
      };
      const loadRunReports = async () => {
        const res = await apiFetch("/ui/run-reports");
        if (!res.ok) return;
        const rows = (res.data.reports || []).map(r => `${r.file} | ${r.mtime}\\n${JSON.stringify(r.summary)}`).join("\\n\\n");
        runReports.textContent = rows || "No data";
      };
      const loadUniqueness = async () => {
        const res = await apiFetch("/ui/uniqueness");
        if (!res.ok) return;
        avgUniqueness.textContent = String(res.data.avg_uniqueness ?? 0);
        avgSimilarity.textContent = String(res.data.avg_similarity ?? 0);
        const rows = (res.data.items || []).map(i => `${i.uniqueness_score}% | sim=${i.semantic_similarity} | ${i.title}`).join("\\n");
        uniquenessList.textContent = rows || "No data";
      };
      const loadFactCheck = async () => {
        const res = await apiFetch("/ui/fact-check");
        if (!res.ok) return;
        factTriangulated.textContent = `${res.data.triangulated_count ?? 0} / ${res.data.total_created ?? 0}`;
        factClear.textContent = String(res.data.clear_count ?? 0);
        factControversial.textContent = String(res.data.controversial_count ?? 0);
        const rows = (res.data.items || []).map(i => `${i.conflict_label} | ${i.fact_check_status} | ${i.title}`).join("\\n");
        factCheckList.textContent = rows || "No data";
      };
      const runSiteAudit = async () => {
        const res = await apiFetch("/ui/run-site-audit", { method: "POST" });
        setStatus("siteAuditStatus", JSON.stringify(res.data));
        await loadSiteAudit();
      };
      const runRemediation = async () => {
        const res = await apiFetch("/ui/run-remediation", { method: "POST" });
        setStatus("siteAuditStatus", JSON.stringify(res.data));
        await loadSiteAudit();
      };
      const runSEONormalize = async () => {
        const res = await apiFetch("/ui/run-seo-normalize", { method: "POST", body: JSON.stringify({ limit: 12 }) });
        setStatus("siteAuditStatus", JSON.stringify(res.data));
      };
      const runQuickCycle = async () => {
        const slot = slotTime.value.trim();
        const res = await apiFetch("/ui/run-quick-cycle", { method: "POST", body: JSON.stringify({ slot_time: slot }) });
        setStatus("siteAuditStatus", JSON.stringify(res.data));
        await loadSchedulerProfile();
      };
      const loadSiteAudit = async () => {
        const res = await apiFetch("/ui/site-audit");
        if (!res.ok || !res.data.latest) {
          siteAuditSummary.textContent = "No audit reports";
          siteAuditIssues.textContent = "No data";
          return;
        }
        const latest = res.data.latest;
        siteAuditSummary.textContent = JSON.stringify(latest.summary || {}, null, 2);
        const issues = latest.issues || [];
        const rows = issues.map(i => `[${i.severity}] ${i.code}: ${i.message} | Fix: ${i.recommended_fix}`).join("\\n");
        siteAuditIssues.textContent = rows || "No issues detected";
      };
      const loadPostingStats = async () => {
        const res = await apiFetch("/ui/posting-stats");
        if (!res.ok) {
          setStatus("postingControlStatus", JSON.stringify(res.data));
          return;
        }
        postingStatsList.textContent = JSON.stringify(res.data, null, 2);
        setStatus("postingControlStatus", "Posting stats loaded");
      };
      const publishTenNow = async () => {
        setStatus("postingControlStatus", "Publishing 10 posts... please wait");
        const res = await apiFetch("/ui/publish-now-bulk", { method: "POST", body: JSON.stringify({ count: 10, language: "en" }) });
        setStatus("postingControlStatus", JSON.stringify(res.data));
        await loadPostingStats();
      };
      const applyHighPlan = async () => {
        const halfDay = parseInt(planHalfDayPosts.value || "20", 10);
        const payload = {
          timezone: scheduleTz.value || "Asia/Karachi",
          start_time: "08:00",
          end_time: "20:00",
          posts_per_half_day: halfDay
        };
        const res = await apiFetch("/ui/apply-high-frequency-plan", { method: "POST", body: JSON.stringify(payload) });
        setStatus("postingControlStatus", JSON.stringify(res.data));
        await loadSchedule();
      };

      const clearKaliOutput = () => {
        kaliTerminalOutput.textContent = "No output yet";
        setStatus("kaliTerminalStatus", "Cleared");
      };
      const runKaliCommand = async () => {
        const command = kaliCommand.value.trim();
        if (!command) {
          setStatus("kaliTerminalStatus", "Command required");
          return;
        }
        setStatus("kaliTerminalStatus", "Running in Kali...");
        kaliTerminalOutput.textContent = "Executing command inside autopost-kali...";
        const res = await apiFetch("/ui/kali-terminal/exec", {
          method: "POST",
          body: JSON.stringify({ command, timeout_seconds: 90 })
        });
        if (!res.ok) {
          kaliTerminalOutput.textContent = JSON.stringify(res.data, null, 2);
          setStatus("kaliTerminalStatus", "Failed to execute Kali command");
          return;
        }

        const data = res.data || {};
        const head = [
          `$ ${data.command || command}`,
          `container: ${data.container || "autopost-kali"}`,
          `status: ${data.status || "unknown"}`,
          data.returncode !== undefined ? `return code: ${data.returncode}` : ""
        ].filter(Boolean).join("\n");
        const stdout = (data.stdout || "").trim();
        const stderr = (data.stderr || "").trim();
        kaliTerminalOutput.textContent = `${head}

--- stdout ---
${stdout || "(empty)"}

--- stderr ---
${stderr || "(empty)"}`;
        setStatus("kaliTerminalStatus", data.status === "ok" ? "Kali command finished" : "Kali command completed with issues");
      };

      const clearTerminalOutput = () => {
        terminalOutput.textContent = "No output yet";
        setStatus("terminalStatus", "Cleared");
      };
      const runTerminalCommand = async () => {
        const command = terminalCommand.value.trim();
        if (!command) {
          setStatus("terminalStatus", "Command required");
          return;
        }
        const cwd = terminalCwd.value.trim() || ".";
        setStatus("terminalStatus", "Running...");
        terminalOutput.textContent = "Executing command...";
        const res = await apiFetch("/ui/cloud-terminal/exec", {
          method: "POST",
          body: JSON.stringify({ command, cwd, timeout_seconds: 45 })
        });
        if (!res.ok) {
          terminalOutput.textContent = JSON.stringify(res.data, null, 2);
          setStatus("terminalStatus", "Failed to execute command");
          return;
        }

        const data = res.data || {};
        const head = [
          `$ ${data.command || command}`,
          `cwd: ${data.cwd || cwd}`,
          `status: ${data.status || "unknown"}`,
          data.returncode !== undefined ? `return code: ${data.returncode}` : ""
        ].filter(Boolean).join("\n");
        const stdout = (data.stdout || "").trim();
        const stderr = (data.stderr || "").trim();
        terminalOutput.textContent = `${head}\n\n--- stdout ---\n${stdout || "(empty)"}\n\n--- stderr ---\n${stderr || "(empty)"}`;
        setStatus("terminalStatus", data.status === "ok" ? "Command finished" : "Command completed with issues");
      };

      const renderChart = (id, points) => {
        const canvas = document.getElementById(id);
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        const w = canvas.width = canvas.clientWidth;
        const h = canvas.height = canvas.clientHeight;
        ctx.clearRect(0, 0, w, h);
        ctx.strokeStyle = "#39d98a";
        ctx.lineWidth = 2;
        ctx.beginPath();
        const max = Math.max(1, ...points);
        points.forEach((v, i) => {
          const x = (i / Math.max(1, points.length - 1)) * (w - 10) + 5;
          const y = h - ((v / max) * (h - 10) + 5);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();
      };
      const loadAll = async () => {
        updateAuthState();
        await loadSites();
        await loadJobs();
        await loadPosts();
        await loadSchedule();
        await loadSEO();
        await loadContentSettings();
        await loadMetrics();
        await loadSchedulerStatus();
        await loadSchedulerDaemonStatus();
        await loadKaliEnvStatus();
        await loadSchedulerProfile();
        await loadRunReports();
        await loadUniqueness();
        await loadFactCheck();
        await loadSiteAudit();
        await loadPostingStats();
      };

      const bootFromCallback = () => {
        const params = new URLSearchParams(window.location.search);
        const callbackToken = params.get("access_token");
        const callbackRefreshToken = params.get("refresh_token");
        if (callbackToken) {
          setToken(callbackToken);
        }
        if (callbackRefreshToken) {
          setRefreshToken(callbackRefreshToken);
        }
        if (callbackToken || callbackRefreshToken) {
          params.delete("access_token");
          params.delete("refresh_token");
          const clean = `${window.location.pathname}${params.toString() ? "?" + params.toString() : ""}`;
          window.history.replaceState({}, "", clean);
        }
      };

      document.getElementById("token").value = getToken();
      bootFromCallback();
      updateAuthState();
    </script>
  </body>
</html>
